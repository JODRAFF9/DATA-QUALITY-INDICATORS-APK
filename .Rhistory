titlePanel("Analyse de la qualité des données démographiques"),
sidebarLayout(
sidebarPanel(
# Upload de fichier
fileInput("file1", "Choisir un fichier Excel",
accept = c(".xlsx", ".xls")),
# Informations
tags$hr(),
helpText("Le fichier doit contenir les colonnes : AGE, Homme, Femme, Total"),
# Sélection des indicateurs
tags$hr(),
checkboxGroupInput("indicateurs", "Indicateurs à calculer:",
choices = c("Indice de Whipple" = "whipple",
"Indice de Myers" = "myers",
"Indice de Bachi" = "bachi",
"Indice combiné Nations Unies" = "nu"),
selected = c("whipple", "myers", "bachi", "nu")),
# Paramètres de la pyramide des âges
tags$hr(),
h4("Pyramide des âges"),
radioButtons("type_pyramide", "Type de pyramide:",
choices = c("Par âge simple" = "simple",
"Groupée (quinquennale)" = "grouped"),
selected = "simple"),
conditionalPanel(
condition = "input.type_pyramide == 'grouped'",
sliderInput("largeur_groupe", "Largeur des groupes (années):",
min = 1, max = 10, value = 5, step = 1)
),
numericInput("age_max", "Âge maximum à afficher:",
value = 100, min = 10, max = 120),
# Boutons d'action
actionButton("calculate", "Calculer les indicateurs",
class = "btn-primary"),
actionButton("plot_pyramid", "Générer la pyramide",
class = "btn-success"),
# Téléchargement des résultats
tags$hr(),
downloadButton("downloadResults", "Télécharger les résultats"),
downloadButton("downloadPyramid", "Télécharger la pyramide")
),
mainPanel(
tabsetPanel(
tabPanel("Données",
DTOutput("contents")),
tabPanel("Résultats Whipple",
verbatimTextOutput("whipple_results"),
plotOutput("whipple_plot")),
tabPanel("Résultats Myers",
verbatimTextOutput("myers_results"),
plotOutput("myers_plot")),
tabPanel("Résultats Bachi",
verbatimTextOutput("bachi_results"),
plotOutput("bachi_plot")),
tabPanel("Résultats Nations Unies",
verbatimTextOutput("nu_results"),
plotOutput("nu_plot")),
tabPanel("Pyramide des âges",
plotlyOutput("pyramid_plot"),
DTOutput("pyramid_data")),
tabPanel("Rapport complet",
verbatimTextOutput("full_report"))
)
)
)
)
# Serveur
server <- function(input, output) {
# Chargement des données
data <- reactive({
req(input$file1)
tryCatch(
{
df <- read_excel(input$file1$datapath)
return(df)
},
error = function(e) {
stop(safeError(e))
}
)
})
# Affichage des données
output$contents <- renderDT({
req(data())
datatable(data(), options = list(scrollX = TRUE, pageLength = 10))
})
# Préparation des données complètes
donnees_completes <- reactive({
req(data())
df_complet <- data.frame(age = 0:99) %>%
left_join(data() %>% rename(age = AGE), by = "age") %>%
mutate(
Homme = ifelse(is.na(Homme), 0, Homme),
Femme = ifelse(is.na(Femme), 0, Femme),
Total = ifelse(is.na(Total), 0, Total)
)
return(df_complet)
})
# Fonction pour préparer les données de la pyramide
pyramid_data <- reactive({
req(donnees_completes(), input$age_max)
df <- donnees_completes() %>%
filter(age <= input$age_max)
if(input$type_pyramide == "grouped") {
# Création des groupes d'âge
largeur_groupe <- input$largeur_groupe
df <- df %>%
mutate(age_group = cut(age,
breaks = seq(0, max(age) + largeur_groupe, largeur_groupe),
right = FALSE,
labels = paste0(seq(0, max(age), largeur_groupe),
"-",
seq(largeur_groupe - 1, max(age) + largeur_groupe - 1, largeur_groupe)))) %>%
group_by(age_group) %>%
summarise(Homme = sum(Homme, na.rm = TRUE),
Femme = sum(Femme, na.rm = TRUE)) %>%
rename(age = age_group) %>%
mutate(age = as.character(age))
} else {
# Âge simple
df <- df %>%
select(age, Homme, Femme) %>%
mutate(age = as.character(age))
}
# Préparation pour la pyramide (Hommes en négatif)
df_long <- df %>%
pivot_longer(cols = c(Homme, Femme),
names_to = "Sexe",
values_to = "Effectif") %>%
mutate(Effectif = ifelse(Sexe == "Homme", -Effectif, Effectif))
return(df_long)
})
# Fonction pour créer la pyramide des âges
create_pyramid <- function() {
req(pyramid_data())
data_plot <- pyramid_data()
p <- ggplot(data_plot, aes(x = age, y = Effectif, fill = Sexe)) +
geom_bar(stat = "identity", position = "identity", alpha = 0.8) +
scale_fill_manual(values = c("Homme" = "steelblue", "Femme" = "lightpink"),
labels = c("Homme" = "Hommes", "Femme" = "Femmes")) +
coord_flip() +
labs(title = paste("Pyramide des âges -",
ifelse(input$type_pyramide == "simple", "Âge simple", "Groupée")),
x = "Âge",
y = "Effectif",
fill = "Sexe") +
scale_y_continuous(labels = function(x) format(abs(x), big.mark = " ")) +
theme_minimal() +
theme(legend.position = "bottom",
plot.title = element_text(hjust = 0.5, face = "bold"),
axis.text.x = element_text(angle = 0, hjust = 0.5))
if(input$type_pyramide == "grouped") {
p <- p + theme(axis.text.y = element_text(size = 8))
}
return(ggplotly(p) %>% layout(legend = list(orientation = "h", x = 0.3, y = -0.1)))
}
# Affichage de la pyramide
output$pyramid_plot <- renderPlotly({
req(input$plot_pyramid)
create_pyramid()
})
# Données de la pyramide
output$pyramid_data <- renderDT({
req(pyramid_data())
data_table <- pyramid_data() %>%
mutate(Effectif = abs(Effectif),
Effectif = round(Effectif, 0))
datatable(data_table,
options = list(scrollX = TRUE, pageLength = 10),
caption = "Données de la pyramide des âges")
})
# Calcul de tous les indicateurs
results <- eventReactive(input$calculate, {
req(data(), donnees_completes())
results_list <- list()
# Indice de Whipple
if("whipple" %in% input$indicateurs) {
results_list$whipple <- indice_whipple(data())
}
# Indice de Myers
if("myers" %in% input$indicateurs) {
results_list$myers <- indice_myers(data())
}
# Indice de Bachi
if("bachi" %in% input$indicateurs) {
pop_m <- donnees_completes()$Homme
pop_f <- donnees_completes()$Femme
results_list$bachi <- indice_bachi(pop_m, pop_f)
}
# Indice combiné Nations Unies
if("nu" %in% input$indicateurs) {
# Préparer les groupes quinquennaux
groupes_quinquenaux <- data.frame(
age = 0:99,
groupe = cut(0:99, breaks = seq(0, 100, 5), right = FALSE, labels = FALSE)
) %>% filter(age < 75)
pop_m_quinquenal <- groupes_quinquenaux %>%
cbind(hommes = donnees_completes()$Homme[1:nrow(groupes_quinquenaux)]) %>%
group_by(groupe) %>%
summarise(hommes = sum(hommes, na.rm = TRUE)) %>%
pull(hommes)
pop_f_quinquenal <- groupes_quinquenaux %>%
cbind(femmes = donnees_completes()$Femme[1:nrow(groupes_quinquenaux)]) %>%
group_by(groupe) %>%
summarise(femmes = sum(femmes, na.rm = TRUE)) %>%
pull(femmes)
taille_pop <- sum(pop_m_quinquenal) + sum(pop_f_quinquenal)
results_list$nu <- indice_combine_nu(pop_m_quinquenal, pop_f_quinquenal, taille_pop)
}
return(results_list)
})
# Affichage des résultats Whipple
output$whipple_results <- renderPrint({
req(results()$whipple)
cat("=== INDICE DE WHIPPLE ===\n\n")
cat("Homme:", round(results()$whipple$homme, 3), "\n")
cat("Femme:", round(results()$whipple$femme, 3), "\n")
cat("Ensemble:", round(results()$whipple$ensemble, 3), "\n\n")
cat("Interprétation:\n")
cat("1 = Aucune attraction/répulsion\n")
cat("5 = Tous les âges terminent par 0 ou 5\n")
cat("<1 = Répulsion pour ces âges\n")
})
# Affichage des résultats Myers
output$myers_results <- renderPrint({
req(results()$myers)
cat("=== INDICE DE MYERS ===\n\n")
print_indice_myers <- function(nom, data_myers) {
cat(toupper(nom), ":\n")
cat("Indice:", round(data_myers$indice, 3), "\n")
cat("Répartition Tu:\n")
print(round(data_myers$Tu, 1))
cat("\n")
}
print_indice_myers("Homme", results()$myers$homme)
print_indice_myers("Femme", results()$myers$femme)
print_indice_myers("Ensemble", results()$myers$ensemble)
cat("Interprétation:\n")
cat("≈0 = Déclarations d'âge exactes\n")
cat(">0 = Préférences pour certains chiffres terminaux\n")
cat("180 = Maximum (préférence pour un seul chiffre)\n")
})
# Affichage des résultats Bachi
output$bachi_results <- renderPrint({
req(results()$bachi)
cat("=== INDICE DE BACHI ===\n\n")
print_indice_bachi <- function(nom, data_bachi) {
cat(toupper(nom), ":\n")
cat("Indice:", round(data_bachi$indice, 3), "\n")
cat("Répartition ru:\n")
for(i in 1:10) {
cat("Chiffre", data_bachi$chiffres[i], ":", round(data_bachi$ru[i], 2), "%\n")
}
cat("\n")
}
print_indice_bachi("Masculin", results()$bachi$masculin)
print_indice_bachi("Féminin", results()$bachi$feminin)
})
# Affichage des résultats Nations Unies
output$nu_results <- renderPrint({
req(results()$nu)
cat("=== INDICE COMBINÉ DES NATIONS UNIES ===\n\n")
cat("Indice brut (I_brut):", round(results()$nu$I_brut, 2), "\n")
cat("Indice net (I_net):", round(results()$nu$I_net, 2), "\n")
cat("J_m (irrégularité masculine):", round(results()$nu$J_m, 2), "\n")
cat("J_f (irrégularité féminine):", round(results()$nu$J_f, 2), "\n")
cat("K (variation masculinité):", round(results()$nu$K, 2), "\n")
cat("Correction S:", round(results()$nu$S_correction, 2), "\n\n")
cat("Qualité des données:\n")
if (results()$nu$I_net < 20) {
cat("→ EXCELLENTE qualité (indice < 20)\n")
} else if (results()$nu$I_net < 40) {
cat("→ BONNE qualité (indice 20-40)\n")
} else if (results()$nu$I_net < 60) {
cat("→ Qualité ACCEPTABLE (indice 40-60)\n")
} else if (results()$nu$I_net < 80) {
cat("→ Qualité MÉDIOCRE (indice 60-80)\n")
} else {
cat("→ TRÈS MAUVAISE qualité (indice > 80)\n")
}
})
# Rapport complet
output$full_report <- renderPrint({
req(results())
cat("=== RAPPORT COMPLET - QUALITÉ DES DONNÉES DÉMOGRAPHIQUES ===\n\n")
# Whipple
if(!is.null(results()$whipple)) {
cat("1. INDICE DE WHIPPLE:\n")
cat("   Homme:", round(results()$whipple$homme, 3), "\n")
cat("   Femme:", round(results()$whipple$femme, 3), "\n")
cat("   Ensemble:", round(results()$whipple$ensemble, 3), "\n\n")
}
# Myers
if(!is.null(results()$myers)) {
cat("2. INDICE DE MYERS:\n")
cat("   Homme:", round(results()$myers$homme$indice, 3), "\n")
cat("   Femme:", round(results()$myers$femme$indice, 3), "\n")
cat("   Ensemble:", round(results()$myers$ensemble$indice, 3), "\n\n")
}
# Bachi
if(!is.null(results()$bachi)) {
cat("3. INDICE DE BACHI:\n")
cat("   Masculin:", round(results()$bachi$masculin$indice, 3), "\n")
cat("   Féminin:", round(results()$bachi$feminin$indice, 3), "\n\n")
}
# Nations Unies
if(!is.null(results()$nu)) {
cat("4. INDICE COMBINÉ DES NATIONS UNIES:\n")
cat("   Indice net:", round(results()$nu$I_net, 2), "\n")
cat("   Qualité: ")
if (results()$nu$I_net < 20) {
cat("EXCELLENTE\n")
} else if (results()$nu$I_net < 40) {
cat("BONNE\n")
} else if (results()$nu$I_net < 60) {
cat("ACCEPTABLE\n")
} else if (results()$nu$I_net < 80) {
cat("MÉDIOCRE\n")
} else {
cat("TRÈS MAUVAISE\n")
}
}
})
# Graphiques simples pour les indicateurs
output$whipple_plot <- renderPlot({
req(results()$whipple)
valeurs <- c(results()$whipple$homme, results()$whipple$femme, results()$whipple$ensemble)
noms <- c("Homme", "Femme", "Ensemble")
barplot(valeurs, names.arg = noms, col = "lightblue",
main = "Indice de Whipple par sexe",
ylab = "Valeur de l'indice")
abline(h = 1, col = "red", lty = 2)
})
output$myers_plot <- renderPlot({
req(results()$myers)
valeurs <- c(results()$myers$homme$indice, results()$myers$femme$indice, results()$myers$ensemble$indice)
noms <- c("Homme", "Femme", "Ensemble")
barplot(valeurs, names.arg = noms, col = "lightgreen",
main = "Indice de Myers par sexe",
ylab = "Valeur de l'indice")
})
# Téléchargement des résultats
output$downloadResults <- downloadHandler(
filename = function() {
paste("resultats-indicateurs-", Sys.Date(), ".txt", sep = "")
},
content = function(file) {
capture.output(print(results()), file = file)
}
)
# Téléchargement de la pyramide
output$downloadPyramid <- downloadHandler(
filename = function() {
paste("pyramide-ages-", Sys.Date(), ".png", sep = "")
},
content = function(file) {
p <- create_pyramid()
htmlwidgets::saveWidget(p, "temp.html")
webshot::webshot("temp.html", file)
file.remove("temp.html")
}
)
}
# Lancement de l'application
shinyApp(ui = ui, server = server)
library(shiny); runApp('D:/Users/hp/Documents/bibliothèque de travail/2 Elève ingénieur/ISE/Cours/ISE3/Tronc commun/UE35 SCIENCES SOCIALES/Analyse démographique M. Faye/DATA QUALITY INDICATORS APK/DATA QUALITY INDICATORS APK.R')
setwd("D:/Users/hp/Documents/bibliothèque de travail/2 Elève ingénieur/ISE/Cours/ISE3/Tronc commun/UE35 SCIENCES SOCIALES/Analyse démographique M. Faye/DATA QUALITY INDICATORS APK")
library(shiny)
library(DT)
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(plotly)
# Sourcer le fichier FUNCTION.R qui contient les fonctions des indicateurs
source("FUNCTIONS.R")
runApp('DATA QUALITY INDICATORS APK.R')
library(readxl)
# Charger les bibliothèques nécessaires
library(dplyr)
library(tidyr)
# INDICE DE WHIPPLE
#L’indice I1 mesure l’importance des effectifs aux âges
#terminant par 0 ou 5 parmi les effectifs de 23 à 62 ans
# Si tous les âges enregistrés se terminent par O ou 5, l'indice
# vaut 5; s'il n'y a aucune attraction ou répulsion pour ces âges, il
# vaut 1 ; s'il y a au contraire répulsion pour ces âges, il est inférieur
#  à 1 et vaut O si aucun âge ne se termine par O ou par 5.
indice_whipple <- function(data) {
print("L’indice I1 mesure l’importance des effectifs aux âges
terminant par 0 ou 5 parmi les effectifs de 23 à 62 ans
Si tous les âges enregistrés se terminent par O ou 5, l'indice
vaut 5; s'il n'y a aucune attraction ou répulsion pour
ces âges, il vaut 1 ; s'il y a au contraire répulsion pour ces âges,
il est inférieur à 1 et vaut O si aucun âge ne se termine par O ou par 5.")
# Âges se terminant par 0 ou 5 entre 25 et 60
ages_A <- c(25, 30, 35, 40, 45, 50, 55, 60)
# Fonction interne pour calculer I1 sur une colonne d’effectif
calc_I1 <- function(effectif_col) {
A <- sum(effectif_col[data$AGE %in% ages_A], na.rm = TRUE)
B <- sum(effectif_col[data$AGE>= 23 & data$AGE <= 62], na.rm = TRUE)
I1 <- 5 * A / B
return(I1)
}
# Calcul pour chaque sexe + total
I1_homme  <- calc_I1(data$Homme)
I1_femme  <- calc_I1(data$Femme)
I1_total  <- calc_I1(data$Total)
print("Indice de Whipple")
# Retour structuré
return(list(
homme = I1_homme,
femme = I1_femme,
ensemble = I1_total
))
}
# Indice de myers
# Si les déclarations d'âge sont exactes, tous les effectifs re-
# maniés sont à peu prEs égaux et l'indice est à peu près nul. Sa va-
# leur est d'autant plus élevée que les préférences ou aversions pour
# les âges se terminant par certains chiffres sont plus grandes. Sa
# valeur maximale est atteinte lorsqu'il y a préférence pour tous les
# âges se terminant par u n seul et même chiffre, et vaut alors 180
indice_myers <- function(data) {
print("Si les déclarations d'âge sont exactes, tous les effectifs remaniés
sont à peu prEs égaux et l'indice est à peu près nul. Sa valeur est d'autant
plus élevée que les préférences ou aversions pour les âges se terminant par
certains chiffres sont plus grandes. Sa valeur maximale est atteinte
lorsqu'il y a préférence pour tous les âges se terminant par un seul et
même chiffre, et vaut alors 180")
# Fonction qui applique le procédé à une colonne d'effectifs
calc_myers <- function(effectif) {
# Étape 1 : Su pour les personnes de 10 ans et plus
ages_10plus <- data$AGE >= 10
ages <- data$AGE[ages_10plus]
eff  <- effectif[ages_10plus]
Su <- sapply(0:9, function(u) sum(eff[ages %% 10 == u], na.rm = TRUE))
# Étape 2 : S'u pour les personnes de 20 ans et plus
ages_20plus <- data$AGE >= 20
ages2 <- data$AGE[ages_20plus]
eff2  <- effectif[ages_20plus]
Su_prime <- sapply(0:9, function(u) sum(eff2[ages2 %% 10 == u], na.rm = TRUE))
# Étape 3 : Tu = (u+1)*Su + (9-u)*S'u
Tu <- sapply(0:9, function(u) (u + 1) * Su[u + 1] + (9 - u) * Su_prime[u + 1])
# Étape 4 : total remanié
T <- sum(Tu)
# Étape 5 : indice de Myers
I2 <- sum(abs(100 * Tu / T - 10))
return(list(
Su = Su,
Su_prime = Su_prime,
Tu = Tu,
T = T,
indice = I2
))
}
# Calcul pour Homme, Femme, Ensemble
return(list(
homme = calc_myers(data$Homme),
femme = calc_myers(data$Femme),
ensemble = calc_myers(data$Total)
))
}
#########################""
# Fonction pour calculer l'indice de Bachi
indice_bachi <- function(pop_m, pop_f) {
# pop_m et pop_f: vecteurs de population par année d'âge (0 à 99 ans)
calculer_composantes <- function(pop) {
# Numérateurs Au selon le tableau 6.5
A0 <- sum(pop[c(30,40,50,60,70)+1])  # +1 car l'index commence à 1
A1 <- sum(pop[c(31,41,51,61,71)+1])
A2 <- sum(pop[c(32,42,52,62,72)+1])
A3 <- 0.5*pop[23+1] + sum(pop[c(33,43,53,63)+1]) + 0.5*pop[73+1]
A4 <- 0.5*pop[24+1] + sum(pop[c(34,44,54,64)+1]) + 0.5*pop[74+1]
A5 <- 0.5*pop[25+1] + sum(pop[c(35,45,55,65)+1]) + 0.5*pop[75+1]
A6 <- 0.5*pop[26+1] + sum(pop[c(36,46,56,66)+1]) + 0.5*pop[76+1]
A7 <- 0.5*pop[27+1] + sum(pop[c(37,47,57,67)+1]) + 0.5*pop[77+1]
A8 <- sum(pop[c(28,38,48,58,68)+1])
A9 <- sum(pop[c(29,39,49,59,69)+1])
# Dénominateurs Du selon le tableau 6.5
B23_72 <- sum(pop[(23:72)+1])
B24_73 <- sum(pop[(24:73)+1])
B25_74 <- sum(pop[(25:74)+1])
B26_75 <- sum(pop[(26:75)+1])
B27_76 <- sum(pop[(27:76)+1])
B28_77 <- sum(pop[(28:77)+1])
D0 <- 0.5 * (B25_74 + B26_75)
D1 <- 0.5 * (B26_75 + B27_76)
D2 <- 0.5 * (B27_76 + B28_77)
D3 <- 0.5 * (B23_72 + B24_73)
D4 <- 0.5 * (B24_73 + B25_74)
D5 <- 0.5 * (B25_74 + B26_75)
D6 <- 0.5 * (B26_75 + B27_76)
D7 <- 0.5 * (B27_76 + B28_77)
D8 <- 0.5 * (B23_72 + B24_73)
D9 <- 0.5 * (B24_73 + B25_74)
A <- c(A0, A1, A2, A3, A4, A5, A6, A7, A8, A9)
D <- c(D0, D1, D2, D3, D4, D5, D6, D7, D8, D9)
ru <- 100 * A / D
ecarts_positifs <- pmax(ru - 10, 0)
indice <- sum(ecarts_positifs)
return(list(indice = indice, ru = ru, chiffres = 0:9))
}
result_m <- calculer_composantes(pop_m)
result_f <- calculer_composantes(pop_f)
return(list(masculin = result_m, feminin = result_f))
}
# Vecteurs de population
pop_m <- donnees_completes$Homme
runApp('DATA QUALITY INDICATORS APK.R')
runApp()
runApp()
